<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMVCar-Server Remote</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; }
        .controls, .laps { margin-bottom: 20px; }
        .control-group { margin-bottom: 10px; }
        button { margin-left: 5px; }
        #lap-table { border-collapse: collapse; width: 300px; }
        #lap-table th, #lap-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #lap-table th { background-color: #f2f2f2; }
        #status { font-weight: bold; }
    </style>
</head>
<body>

    <h1>Stopwatch Remote</h1>
    <p>Connection Status: <span id="status">Disconnected</span></p>

    <div class="controls">
        <div class="control-group">
            <button id="lap-button" style="width: 200px; height: 50px; font-size: 20px;">Lap</button>
        </div>
        <div class="control-group">
            <label for="target-laps">Target Laps:</label>
            <input type="number" id="target-laps" name="target-laps" min="1">
            <button id="set-target-laps-button">Set</button>
        </div>
        <div class="control-group">
            <label for="target-time">Target Time (minutes):</label>
            <input type="number" id="target-time" name="target-time" min="1">
            <button id="set-target-time-button">Set</button>
        </div>
    </div>

    <div class="laps">
        <h2>Laps</h2>
        <table id="lap-table">
            <thead>
                <tr>
                    <th>Lap</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <!-- Lap data will be inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const lapButton = document.getElementById('lap-button');
        const setTargetLapsButton = document.getElementById('set-target-laps-button');
        const targetLapsInput = document.getElementById('target-laps');
        const setTargetTimeButton = document.getElementById('set-target-time-button');
        const targetTimeInput = document.getElementById('target-time');
        const lapTableBody = document.querySelector('#lap-table tbody');

        let socket;
        let messageIdPrefix = '';
        let nextMessageId = 0;
        let clientId = -1;

        function connect() {
            // Use ws:// or wss:// depending on the page protocol
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            socket = new WebSocket(`${protocol}//${host}`);

            socket.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.style.color = 'green';
            };

            socket.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.style.color = 'red';
                // Try to reconnect after 3 seconds
                setTimeout(connect, 3000);
            };

            socket.onmessage = (event) => {
                const command = JSON.parse(event.data);
                handleServerMessage(command);
            };

            socket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                socket.close();
            };
        }

        function sendMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                console.warn('WebSocket is not connected. Message not sent:', message);
            }
        }

        function nextCommandId() {
            return `${messageIdPrefix}${nextMessageId++}`;
        }

        function handleServerMessage(command) {
            const { function: func, command_id } = command;

            if (func === 'setId') {
                clientId = command.client_id;
            } else if (func === 'setPrefix') {
                messageIdPrefix = command.message_prefix;
            } else if (func === 'addLap') {
                addLapRow(command.timestamp, command_id);
            } else if (func === 'removeLap') {
                removeLapRow(command_id);
            } else if (func === 'reject') {
                // The C++ client removes the lap on reject.
                removeLapRow(command.command_id);
            }
            // The other functions from the C++ client seem to be for the stopwatch display logic,
            // which this client doesn't have. The server will send 'addLap' which contains the timestamp.
            // The client should then calculate the lap times itself based on the timestamps.
            recalculateTable();
        }

        function addLapRow(timestamp, commandId) {
            const row = document.createElement('tr');
            row.dataset.commandId = commandId;
            row.dataset.timestamp = timestamp;
            row.innerHTML = `
                <td>-</td>
                <td>-</td>
            `;
            // Insert at the top
            lapTableBody.insertBefore(row, lapTableBody.firstChild);
        }

        function removeLapRow(commandId) {
            const row = lapTableBody.querySelector(`tr[data-command-id="${commandId}"]`);
            if (row) {
                row.remove();
            }
        }

        function recalculateTable() {
            const rows = Array.from(lapTableBody.querySelectorAll('tr'));
            // Sort by timestamp descending to get laps in order
            rows.sort((a, b) => new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp));

            // Clear and re-add sorted rows
            lapTableBody.innerHTML = '';
            rows.forEach(row => lapTableBody.appendChild(row));

            // Recalculate lap numbers and times
            for (let i = 0; i < rows.length; i++) {
                const currentRow = rows[i];
                const lapNumber = rows.length - i;
                currentRow.cells[0].textContent = lapNumber;

                if (i < rows.length - 1) {
                    const previousRow = rows[i + 1];
                    const lapStartTime = new Date(previousRow.dataset.timestamp);
                    const lapEndTime = new Date(currentRow.dataset.timestamp);
                    const diffMs = lapEndTime - lapStartTime;

                    const minutes = String(Math.floor(diffMs / 60000)).padStart(2, '0');
                    const seconds = String(Math.floor((diffMs % 60000) / 1000)).padStart(2, '0');
                    const centiseconds = String(Math.floor((diffMs % 1000) / 10)).padStart(2, '0');

                    currentRow.cells[1].textContent = `${minutes}:${seconds}.${centiseconds}`;
                } else {
                    // First lap has no previous lap to compare to
                    currentRow.cells[1].textContent = '00:00.00';
                }
            }
        }


        lapButton.onclick = () => {
            const message = {
                function: 'lap',
                timestamp: new Date().toISOString(),
                command_id: nextCommandId()
            };
            sendMessage(message);
        };

        setTargetLapsButton.onclick = () => {
            const laps = parseInt(targetLapsInput.value, 10);
            if (!isNaN(laps) && laps > 0) {
                sendMessage({
                    function: 'setTargetLaps',
                    target_laps: laps
                });
            }
        };

        setTargetTimeButton.onclick = () => {
            const time = parseInt(targetTimeInput.value, 10);
            if (!isNaN(time) && time > 0) {
                sendMessage({
                    function: 'setTargetTime',
                    target_time: time // Sending as minutes
                });
            }
        };

        // Initial connection
        connect();
    </script>

</body>
</html>
