<!DOCTYPE html>
<html lang="en">

<!-- NOTE: This file was written by AI, but the original logic is my own. -->
<!-- The only thing the AI did was convert my logic from C++ to JavaScript. -->
<!-- NEW: AI also did the website design. It's better than I could do and works fine, so I'm keeping it. -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMVCar Interface</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg:        #0a0a0b;
            --surface:   #111114;
            --border:    #222228;
            --accent:    #e83030;
            --accent-dim:#a02020;
            --text:      #e0e0e0;
            --text-dim:  #666670;
            --red:       #e83030;
            --green:     #00e87a;
            --mono:      'Share Tech Mono', monospace;
            --sans:      'Barlow Condensed', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--sans);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            overflow-x: hidden;
        }

        /* Top bar */
        .topbar {
            width: 100%;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 48px;
            letter-spacing: 0.15em;
        }

        .topbar-title {
            font-family: var(--sans);
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: var(--accent);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-dim);
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--red);
            transition: background 0.3s;
        }

        .status-dot.connected { background: var(--green); }

        /* Main content */
        .main {
            width: 100%;
            max-width: 480px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* Total time display */
        .time-display {
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom: none;
            padding: 20px 24px 16px;
        }

        .time-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: var(--text-dim);
            margin-bottom: 4px;
            padding-left: 4px;
        }

        .time-value {
            font-family: var(--mono);
            font-size: 52px;
            line-height: 1;
            color: var(--accent);
            letter-spacing: 0.02em;

        }

        /* Controls row */
        .controls {
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom: none;
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lap-btn {
            width: 100%;
            height: 56px;
            background: var(--accent);
            color: #000;
            border: none;
            font-family: var(--sans);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            cursor: pointer;
            transition: background 0.1s, transform 0.1s;
            position: relative;
            overflow: hidden;
        }

        .lap-btn:active {
            transform: scale(0.98);
            background: var(--accent-dim);
        }

        .lap-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.1s;
        }

        .lap-btn:hover::after { opacity: 1; }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-dim);
        }

        .setting-input-row {
            display: flex;
            gap: 6px;
        }

        .setting-input-row input {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--mono);
            font-size: 14px;
            padding: 7px 10px;
            outline: none;
            transition: border-color 0.2s;
            -moz-appearance: textfield;
        }

        .setting-input-row input::-webkit-inner-spin-button,
        .setting-input-row input::-webkit-outer-spin-button { -webkit-appearance: none; }

        .setting-input-row input:focus { border-color: var(--accent); }

        .set-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: var(--sans);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            padding: 0 12px;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
            white-space: nowrap;
        }

        .set-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Lap table */
        .table-container {
            background: var(--surface);
            border: 1px solid var(--border);
        }

        .table-header {
            display: grid;
            grid-template-columns: 60px 1fr;
            padding: 8px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .table-header span {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            color: var(--text-dim);
        }

        #lap-table-body {
            display: flex;
            flex-direction: column;
        }

        .lap-row {
            display: grid;
            grid-template-columns: 60px 1fr;
            padding: 10px 24px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
            animation: rowIn 0.2s ease;
        }

        .lap-row:last-child { border-bottom: none; }
        .lap-row:hover { background: rgba(255,255,255,0.02); }

        .lap-row.active { background: rgba(232, 255, 0, 0.04); }

        @keyframes rowIn {
            from { opacity: 0; transform: translateY(-4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .lap-num {
            font-family: var(--sans);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dim);
            letter-spacing: 0.1em;
        }

        .lap-time {
            font-family: var(--mono);
            font-size: 15px;
            color: var(--text);
        }

        .lap-row.active .lap-time {
            color: var(--accent);
        }

        .empty-state {
            padding: 32px 24px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-dim);
        }


    </style>
</head>
<body>

<div class="topbar">
    <div class="topbar-title">SMVCar Interface</div>
    <div class="status-indicator">
        <div class="status-dot" id="status-dot"></div>
        <span id="status">Offline</span>
    </div>
</div>

<div class="main">
    <div class="time-display">
        <div class="time-label">Total Time</div>
        <div class="time-value" id="total-time">00:00.00</div>
    </div>

    <div class="controls">
        <button class="lap-btn" id="lap-button">Lap</button>
        <div class="settings-row">
            <div class="setting-group">
                <div class="setting-label">Target Laps</div>
                <div class="setting-input-row">
                    <input type="number" id="target-laps" min="1" placeholder="—">
                    <button class="set-btn" id="set-target-laps-button">Set</button>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-label">Target Time (min)</div>
                <div class="setting-input-row">
                    <input type="number" id="target-time" min="1" placeholder="—">
                    <button class="set-btn" id="set-target-time-button">Set</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="table-header">
            <span>Lap</span>
            <span>Time</span>
        </div>
        <div id="lap-table-body">
            <div class="empty-state" id="empty-state">No laps recorded</div>
        </div>
    </div>
</div>

<script>
    const statusEl   = document.getElementById('status');
    const statusDot  = document.getElementById('status-dot');
    const lapButton  = document.getElementById('lap-button');
    const totalTimeEl = document.getElementById('total-time');
    const lapTableBody = document.getElementById('lap-table-body');
    const emptyState = document.getElementById('empty-state');
    const targetLapsInput = document.getElementById('target-laps');
    const targetTimeInput = document.getElementById('target-time');

    let socket;
    let messageIdPrefix = '';
    let nextMessageId = 0;
    let rows = [];
    let isRunning = false;
    let updateInterval = null;
    let pendingMessages = [];

    // ---- WebSocket ----

    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const url = `${protocol}//${window.location.host}`;
        console.log(`[WS] Connecting to ${url}`);
        socket = new WebSocket(url);

        socket.onopen = () => {
            console.log('[WS] Connected');
            statusEl.textContent = 'Online';
            statusDot.classList.add('connected');
        };

        socket.onclose = (e) => {
            console.warn(`[WS] Disconnected - code: ${e.code}`);
            statusEl.textContent = 'Offline';
            statusDot.classList.remove('connected');
            setTimeout(connect, 3000);
        };

        socket.onmessage = (e) => {
            console.log('[WS] Received:', e.data);
            processMessage(JSON.parse(e.data));
        };

        socket.onerror = (e) => {
            console.error('[WS] Error:', e);
            socket.close();
        };
    }

    // ---- Message handling ----

    function processMessage(command) {
        const pendingIndex = pendingMessages.findIndex(msg => {
            const pending = JSON.parse(msg);
            return pending.command_id && pending.command_id === command.command_id;
        });

        if (pendingIndex !== -1) {
            console.log(`[WS] Matched pending: ${command.command_id}`);
            if (command.function === 'reject') {
                console.warn(`[WS] Rejected: ${command.command_id}`);
                removeRow(command.command_id);
            }
            pendingMessages.splice(pendingIndex, 1);
            return;
        }

        const func = command.function;
        console.log(`[WS] Server message: ${func}`);

        if (func === 'setPrefix') {
            messageIdPrefix = command.message_prefix;
        } else if (func === 'setTargetLaps') {
            targetLapsInput.value = command.target_laps;
        } else if (func === 'setTargetTime') {
            targetTimeInput.value = command.target_time;
        } else if (func === 'startStopwatch') {
            addRow(new Date(command.timestamp), command.command_id);
            startTimer();
        } else if (func === 'stopStopwatch') {
            stopTimer();
        } else if (func === 'lap') {
            addRow(new Date(command.timestamp), command.command_id);
        } else if (func === 'resetStopwatch') {
            reset();
        }
    }

    // ---- Timer ----

    function startTimer() {
        isRunning = true;
        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(updateTime, 50);
        updateTime();
    }

    function stopTimer() {
        isRunning = false;
        if (updateInterval) { clearInterval(updateInterval); updateInterval = null; }
        updateTime();
    }

    function formatTime(ms) {
        if (ms < 0) ms = 0;
        const minutes      = String(Math.floor(ms / 60000)).padStart(2, '0');
        const seconds      = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
        const centiseconds = String(Math.floor((ms % 1000) / 10)).padStart(2, '0');
        return `${minutes}:${seconds}.${centiseconds}`;
    }

    function updateTime() {
        if (rows.length === 0) return;
        const now = new Date();

        // Total time from oldest row
        totalTimeEl.textContent = formatTime(now - rows[rows.length - 1].timestamp);

        // Update active lap cell (first row in the rendered table)
        const activeRowEl = lapTableBody.querySelector('.lap-row.active');
        if (activeRowEl && isRunning) {
            activeRowEl.querySelector('.lap-time').textContent = formatTime(now - rows[0].timestamp);
        }
    }

    // ---- Row management ----

    function addRow(timestamp, commandId) {
        console.log(`[UI] addRow - ${commandId}`);
        rows.push({ timestamp, commandId });
        recalculateTable();
    }

    function removeRow(commandId) {
        const index = rows.findIndex(r => r.commandId === commandId);
        if (index !== -1) {
            rows.splice(index, 1);
            recalculateTable();
        } else {
            console.warn(`[UI] removeRow - not found: ${commandId}`);
        }
    }

    function reset() {
        rows = [];
        stopTimer();
        totalTimeEl.textContent = '00:00.00';
        recalculateTable();
    }

    function recalculateTable() {
        rows.sort((a, b) => b.timestamp - a.timestamp);

        lapTableBody.innerHTML = '';

        if (rows.length === 0) {
            lapTableBody.appendChild(emptyState);
            return;
        }

        for (let i = 0; i < rows.length; i++) {
            const el = document.createElement('div');
            el.className = 'lap-row' + (i === 0 ? ' active' : '');
            el.dataset.commandId = rows[i].commandId;

            const lapNumber = rows.length - i;
            let lapTimeStr = '00:00.00';
            if (i < rows.length - 1) {
                lapTimeStr = formatTime(rows[i].timestamp - rows[i + 1].timestamp);
            }

            el.innerHTML = `<span class="lap-num">${String(lapNumber).padStart(2, '0')}</span><span class="lap-time">${lapTimeStr}</span>`;
            lapTableBody.appendChild(el);
        }
    }

    // ---- Sending ----

    function nextCommandId() { return `${messageIdPrefix}${nextMessageId++}`; }

    function sendMessage(message) {
        const str = JSON.stringify(message);
        console.log('[WS] Sending:', str);
        flushQueue();
        pendingMessages.push(str);
        if (socket && socket.readyState === WebSocket.OPEN) socket.send(str);
        else console.warn('[WS] Queued (not connected)');
    }

    function flushQueue() {
        if (!socket || socket.readyState !== WebSocket.OPEN) return;
        for (const msg of pendingMessages) socket.send(msg);
    }

    // ---- Button handlers ----

    lapButton.onclick = () => {
        const time = new Date();
        const commandId = nextCommandId();
        addRow(time, commandId);
        sendMessage({ function: 'lap', timestamp: time.toISOString(), command_id: commandId });
    };

    document.getElementById('set-target-laps-button').onclick = () => {
        const laps = parseInt(targetLapsInput.value, 10);
        if (!isNaN(laps) && laps > 0)
            sendMessage({ function: 'setTargetLaps', target_laps: laps, command_id: nextCommandId() });
    };

    document.getElementById('set-target-time-button').onclick = () => {
        const time = parseInt(targetTimeInput.value, 10);
        if (!isNaN(time) && time > 0)
            sendMessage({ function: 'setTargetTime', target_time: time, command_id: nextCommandId() });
    };

    connect();
</script>
</body>
</html>